@*_verna_0930*@
@model homepage.ViewModel.CMapItem
@using homepage.ViewModel
@using homepage.Models
@{
    Layout = null;
    if (Session[CDictionary.SK_MemberId] == null)
    {
        Session[CDictionary.SK_MemberId] = CDictionary.SK_anonymous;
    }

}

<!DOCTYPE html>

<html>
<head>

    @*20200916_15*@
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FunDayTrip</title>
    <link href="https://www.jqueryscript.net/css/jquerysctipttop.css" rel="stylesheet" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


    <!-- 測滑動菜單Bootstrap _verna_0930-->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="../../css/BootSideMenu.css" rel="stylesheet">

    @*jquery__verna_0930*@
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    @*地圖*@
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    @*mapbox plugins directions _verna_0930*@
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css" type="text/css" />

    <!-- 測滑動菜單Bootstrap _verna_0930 -->
    <script src="../../js/BootSideMenu.js"></script> @*位置要放在地圖後*@

    @*mapbox plugins language*@
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v0.10.1/mapbox-gl-language.js'></script>
    @*sweet alert cdn _verna_0930*@
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    @*CustomerCSS.css _verna_0930*@
    <link href="~/css/CustomerlizeCSSofLocationAndRoute.css" rel="stylesheet" />
    @*jquery.form.js _verna_0930*@
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.3.0/jquery.form.min.js" integrity="sha384-qlmct0AOBiA2VPZkMY3+2WqkHtIQ9lSdAsAn5RUJD/3vA5MKDgSGcdmIv4ycVxyn" crossorigin="anonymous"></script>



    @*-------------聊天室CSS---------------*@
    <link rel="stylesheet" type="text/css" href="~/css/test.css" />



    @*contextmenu _verna_0930*@
    @*<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>*@
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.contextMenu.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.contextMenu.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.ui.position.js"></script>

    @*_verna_0930*@
    <style>
        /*通知按鈕*/
        .noteBtn {
            width: 32px;
            height: 32px;
            position: relative;
            display: inline-block;
            margin: 0px;
        }
        /*通知數量*/
        .noteNum {
            position: absolute;
            top: -10px;
            right: -10px;
            padding: 2px 2px;
            border-radius: 50%;
            background: red;
            color: white;
            font-size: xx-small;
        }

        .info_panel {
            overflow: auto;
        }
    </style>

</head>
<body>



    @*地圖 /綁定右鍵清單_verna_0930*@
    <div id='map' class="context-menu-one btn btn-neutral"></div>

    @*上列選項清單_verna_0930 *@
    @Html.Partial("_topMenuNavigation");
    @*滑鼠右鍵清單*@
    @Html.Partial("_ContextMenuPartialView");

    @*---------------------------------聊天室生成 2020/09/24 by曾開誠---------------------------------*@
    @*_verna_0930*@
    @Html.Partial("_ChatBoxPartialView");
    @*---------------------------------聊天室生成---------------------------------*@


    <script>
        //全域變數===============================
        //經緯度變數
        var _lng, _lat;
        var Addedmarker;

        //要求顯示地圖===========================
        //顯示中文地圖
        mapboxgl.accessToken = 'pk.eyJ1IjoidmVybmFuYW5hbmFuYW5hbmFuYSIsImEiOiJja2VtbjM3MXgwOG53MnlzYWh4b3ozb3l4In0.WV0nJqpHVfMdABV83v_6hQ';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v10',
            center: [120.757769, 23.535394],
            zoom: 8
        });
        //改成中文
        var language = new MapboxLanguage({ defaultLanguage: 'zh' });
        map.addControl(language);
        //地圖一載入==================================
        map.on('load', function () {
            map.on('click', 'places', function (e) {

                // Change the cursor style as a UI indicator.
                map.getCanvas().style.cursor = 'pointer';

                var coordinates = e.features[0].geometry.coordinates.slice();
                var LocationID = e.features[0].properties.description;

                //CATCH ID跟座標
                document.getElementById("clickInfo").innerHTML = LocationID + "<br/>" + coordinates + "<br/>";
                _LocationID = LocationID;
                _fX_Coordinate = coordinates[0];
                _fY_Coordinate = coordinates[1];
                Coords_Location = [_fX_Coordinate, _fY_Coordinate];
                //console.log(Coords_Location);
                fly(Coords_Location);
                //顯示該地點詳細內容
                $.ajax({
                    url: "/Home/CallBackThisLocationInfo",///////////////////////
                    type: "POST",
                    data: { locationID: LocationID },
                    //dataType: "json",
                }).done(function (response) {
                    var deJsonResponce = JSON.parse(response);
                    deJsonResponce.forEach((item, element) => {
                        $("#showExistedPhoto").attr("src", item.fPath_Photo);
                        $("#showExistedPhotoTitle").text(item.fTitle_Photo)
                        $("#showExistedPhtoDescription").text(item.fDescript_Photo)
                        $("#showExistedLocationTime").text(item.fTime_Location);
                        $("#showExistedLocationName").text(item.fName_Location);
                        $("#showExistedLocationAddress").text(item.fAdd_Location);
                        $("#showExistedLocationDescription").text(item.fDescript_Location);
                    });
                }).fail(function (xhr) {
                    console.log(xhr.status + xhr.responseText);
                });//end ajax
            });
        });

    </script>

    @*  左側內容 _verna_0930  ===========================*@
    <div id="LeftSideMenu">

        <button id="test" onclick="closethisdiv()">next2</button>

        <div id="Result_List2">
            @*地點路線資訊*@
            @Html.Partial("_firstLoadAllListPartialView");
        </div>




        <div style="position:absolute" id="locationInfo">

            <img id="showExistedPhoto" style="height:400px;width:280px" />
            <br />
            <span id="clickInfo"></span>
            <button id="EditExistedLocation" onclick="CallBackThisLocationInfoWhenEditor()">編輯</button>
            @*按已存在地點的編輯按鈕*@
            <br />
            照片標題:
            <p id="showExistedPhotoTitle"></p>
            照片心得
            <p id="showExistedPhtoDescription"></p>
            時間:
            <p id="showExistedLocationTime"></p>
            地點名稱:
            <p id="showExistedLocationName"></p>
            地址:
            <p id="showExistedLocationAddress"></p>
            地點心得:
            <p id="showExistedLocationDescription"></p>
            <br />
            <button id="testButton" onclick="reload()">next</button>
            <button id="testButton2" onclick="reloadlocation()">reload</button>



        </div>


    </div>

    <script>
        //文件載入鎖定部分按鈕事件/顯示_verna_0930
        $(document).ready(function () {
            //個人資料方塊
            $("#locationInfo").hide();
        });
        //顯示關閉左邊表單
        function closethisdiv() {

            $("#Result_List2").toggle();

            $('#locationInfo').toggle();


        };

    </script>



    @*地圖中放置內容/按鍵(上)=====================*@
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                @*新增地點*@
                <span id="info2">get coordinates</span>
                <button id="addNewLocationButton" type="button" class="btn btn-danger">放置新增圖釘</button>

                @*開啟個人資料對話方塊*@
                <button id="toggle2" type="button" class="showHideButton">User</button>
                @*輸入登入資訊 by 王詠平 0921*@
                <div class="showHide" id="showHide">
                    <div>
                        @*如果沒有登入*@
                        @if (Session[CDictionary.SK_MemberId].ToString() == CDictionary.SK_anonymous)
                        {
                            <input type="text" id="account" value="ming123@gmail.com">
                            <input type="password" id="password" value="ming123">
                            <button type="submit" id="loginBtn">登入</button>
                            <br />
                            @Html.ActionLink("註冊會員", "signUp", "Member")
                            @*<button type="submit" id="signupBtn">註冊帳號</button>*@
                            <button type="submit" id="forgetPwdBtn" onclick="window.open('../ForgetPassword.aspx', 'FP', 'width=500,height=50,top=300,left=500,fullscreen=no,resizable=0');">忘記密碼</button>
                        }
                        @*如果已經登入，顯示登入資訊*@
                        @if (Session[CDictionary.SK_MemberId].ToString() != CDictionary.SK_anonymous)
                        {
                            CLoginViewModel memberLogin = (CLoginViewModel)Session[CDictionary.SK_MemberLogin];
                            <img id="profile_photo" class="profile_photo" src="https://i.imgur.com/vyWwMlr.png" width="64" style="float:left" />
                            <input id="login_id" style="display:none" value="@memberLogin.fId_Member">
                            <div id="active_role_name">目前身分:@memberLogin.fActiveRoleName_Member</div>
                            <div id="login_email">@memberLogin.fEmail_Member</div>
                            <button id="logoutBtn" style="float:right">登出</button>
                            <br />
                            <input type="text" id="active_role" style="display:none" value="@memberLogin.fActiveRoleId_Member">
                            <div id="login_name">會員名稱:@memberLogin.fNickName_Member</div>
                            <a id="login_point" href="javascript:showPoint()">點數: @memberLogin.fPointTotal_Member</a>
                            <button id="change_role" style="float:left" onclick="showRoles()">切換身分</button>
                            @Html.ActionLink("編輯個人檔案", "edit", "Member")
                            @*<button id="edit_profile" style="float:right" >編輯個人檔案</button><br />*@
                            <hr />

                            //通知按鈕
                            <div class="noteBtn">
                                <input type="image" id="noteBtn" name="noteBtn" onclick="showNotes()" img src="https://i.imgur.com/ShdEgwx.png" width="32" height="32">
                                @if (memberLogin.fNotesCount_Member > 0)
                                {
                                    <span id="noteNum" name="noteNum" class="noteNum">
                                        @memberLogin.fNotesCount_Member
                                    </span>
                                }
                            </div>
                            <hr />
                            <div id="info_panel" class="info_panel">
                                <ul id="note_list"></ul>
                                <ul id="role_list"></ul>
                            </div>
                            //通知按鈕
                        }
                    </div>

                </div>
                @*聊天室方塊 by曾開誠 註解已改為動態生成 function creatchatroom <div id="CHAT"不可刪>*@
                <div id="CHAT"></div>


                @*-----------------------------------追蹤粉絲頁面 by曾開誠09/23-------------------------------*@
                <div id="follow_modal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <div style="justify-content:center;">
                            <button class="btn btn-info" onclick="showfollower()" type="submit">追隨中</button>
                            <button class="btn btn-info" onclick="showfans()" type="submit">粉絲</button>
                            <div id="follower_list"></div>
                        </div>
                    </div>
                </div>
                @*-----------------------------------追蹤粉絲頁面 by曾開誠09/23-------------------------------*@

            </div>
        </div>
        @*跳出新增/編輯視窗*@
        <div id="myModal" class="modal">

            <div class="modal-content ">
                <form form method="post" enctype="multipart/form-data" id="UploadLocationForm">
                    @Html.Partial("_CreateOrEditForm");
                </form>
            </div>@*model-contain*@
        </div>@*model*@
    </div>
    @*</div>*@

    @* 設定地圖中內容的事件 ==================*@
    <script>
       
        //叉叉:關閉資料表單
        var span = document.getElementsByClassName("close")[0];
        //左側彈出視窗 X按鈕
        $(".close").on("click", function () {
            CreateEditmodal.style.display = "none";
            follow_modal.style.display = "none";

        });

        ///////////////////////////////////////
        //粉絲/追蹤彈跳視窗
        function followcon() {
            if ($("#active_role").val() == false) {
                alert("請先登入");
            }
            else {
                follow_modal.style.display = "block";
            }
        };
        //粉絲/追蹤頁面按下追隨中按鈕 by曾開誠
        function showfollower() {
            $.ajax({
                url: "/Home/showFollow",
                type: "POST",
                dataType: "json",
                data: { role_id: $("#active_role").val() },
                success: function (response) {
                    console.log(response);
                    $("#follower_list").html("");
                    for (let i = 0; i < response.length; i++) {

                        let CD = '<tr>';
                        CD += '<td>' + response[i].follow_Self_Name + '</td>';
                        CD += '<td>';
                        CD += '<button class="btn btn-link" onclick="creatchatroom(this)" name="';
                        //style="border-bottom:dashed;margin-bottom:5px;border-color:blue;"
                        CD += response[i].follow_Self_Name;
                        CD += '"';
                        CD += 'value="';
                        CD += response[i].follow_Self_ID;
                        CD += '">';
                        CD += '聊天</button>';
                        CD += '</td>';
                        CD += '</tr>';

                        CD += '<div></div>'
                        $("#follower_list").prepend(CD);
                    }
                }
            });
        };
        //粉絲/追蹤頁面按下粉絲按鈕 by曾開誠
        function showfans() {
            $.ajax({
                url: "/Home/showFan",
                type: "POST",
                dataType: "json",
                data: { role_id: $("#active_role").val() },
                success: function (response) {
                    console.log(response);
                    $("#follower_list").html("");
                    for (let i = 0; i < response.length; i++) {
                        let CD = '<tr>';
                        CD += '<td>' + response[i].follow_Target_Name + '</td>';
                        CD += '<td>';
                        CD += '<button class="btn btn-link" onclick="creatchatroom(this)" name="';
                        //style="border-bottom:dashed;margin-bottom:5px;border-color:blue;"
                        CD += response[i].follow_Target_Name;
                        CD += '"';
                        CD += 'value="';
                        CD += response[i].follow_Target_ID;
                        CD += '">';
                        CD += '聊天</button>';
                        CD += '</td>';
                        CD += '</tr>';

                        CD += '<div></div>'

                        $("#follower_list").prepend(CD);
                    }
                }
            });
        };

        ///////////////////////////////////////////////////
        //我的地點 顯示可新增按鈕
        function showMyLoc() {
            $("#addNewLocationButton").show();
        };
        //取得新增/編輯資料 表單id
        var CreateEditmodal = document.getElementById("myModal");
        //關閉新增/編輯資料 表單
        var span = document.getElementsByClassName("close")[0];
        $("#closeAddLocationForm").on("click", function () {
            CreateEditmodal.style.display = "none";
            //console.log(_marker);
            if ( _marker != undefined) {
                _marker.remove();
            };
            
           
            $("#addNewLocationButton").one("click", enableAddLocation);//click(enableAddLocation); //呼叫函式:新增地點一開始的畫面
        });

        //點選新增地點,才可添加marker
        var _marker;//地圖上marker變數
        $("#addNewLocationButton").one("click", enableAddLocation);//click(enableAddLocation); //呼叫函式:新增地點一開始的畫面


        //函式:新增地點一開始的畫面
        function enableAddLocation() {
            _marker = new mapboxgl.Marker()
                .setLngLat([120.757769, 23.535394])
                .addTo(map);
            //地圖上點選地點,在此綁定map click 另一個handler
            map.on('click', positioningClickLocate);
            ////地圖上雙擊決定添加的地點-------------改成按右鍵
           
        };

        //函式:alert尋問是否要新增此地點
        function alertIfAddLocation() {
            Swal.fire({
                title: '要新增此地點嗎?',
                //text: "You won't be able to revert this!",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes'
            }).then((result) => {
                if (result.isConfirmed) {
                    console.log("yes");
                    CreateEditmodal.style.display = "block";
                    document.getElementById("UploadLocationForm").reset();
                    $("#save").hide();
                    $("#create").show();
                    $("#fx_Coordinate").val(_lng);
                    $("#fy_Coordinate").val(_lat);
                    $("#CreateOrEdit").text("新增地點");
                    document.getElementById('info3').innerHTML = _lng + "," + _lat;
                    _LocationID = "noLocationID";
                    console.log("新增時的id" + _LocationID + _lat + _lng);

                } else {
                    console.log("no");
                    _marker.remove();
                    $("#addNewLocationButton").one("click", enableAddLocation);
                   
                }
            })


        }

        //新增時,在地圖上要新增的點
        function positioningClickLocate(e) {

            document.getElementById('info2').innerHTML =
                // e.point is the x, y coordinates of the mousemove event relative
                // to the top-left corner of the map
                //"x: " + e.point.x + "     y: " + parseFloat(e.point.y) +
                //'<br />' +
                // e.lngLat is the longitude, latitude geographical position of the event
                "lng: " + parseFloat(e.lngLat.lng) +
                "<br/>lat: " + parseFloat(e.lngLat.lat);

            _lng = parseFloat(e.lngLat.lng);
            _lat = parseFloat(e.lngLat.lat);

            _marker.setLngLat([_lng, _lat]);
        };

        //按編輯按鈕帶出該筆info
        function CallBackThisLocationInfoWhenEditor() {
            document.getElementById("UploadLocationForm").reset();
            $("#create").hide();
            $("#save").show();
            CreateEditmodal.style.display = "block";
            console.log("編輯時的id" + _LocationID);///////////////////////////
            $("#CreateOrEdit").text("編輯地點");
            //顯示該地點詳細內容
            $.ajax({
                url: "/Home/CallBackThisLocationInfo",
                type: "POST",
                data: { locationID: _LocationID },
            }).done(function (response) {
                var deJsonResponce = JSON.parse(response);

                deJsonResponce.forEach((item, element) => {


                    $("#fId_Location").val(item.fId_Location);
                    $("#fx_Coordinate").val(item.fX_Coordinate);
                    $("#fy_Coordinate").val(item.fY_Coordinate);
                    $("#CoordinateName").val(item.fName_Coordinate);
                    //console.log(item.fName_Coordinate);
                    $("#LocationName").val(item.fName_Location);
                    $("#fAdd_Location").val(item.fAdd_Location);
                    $("#fDescript_Location").val(item.fDescript_Location);
                    //console.log(item.fDescript_Location);
                    $("#fTitle_Photo").val(item.fTitle_Photo);
                    $("#fDescript_Photo").val(item.fDescript_Photo);
                    $("#output").attr("src", item.fPath_Photo);//IMAGE

                    console.log(item.fDelete_Location);
                    if (item.fDelete_Location == 1) {
                        $('#checkbox').prop("checked", true)
                    } else {
                        $('#checkbox').prop("checked", false)
                    }

                    $('#selector option').removeAttr('selected');
                    if (item.fId_ShareAuth == 3) {
                        $('#selector option[value=3]').attr('selected', 'selected');
                    } else if (item.fId_ShareAuth == 2) {
                        $('#selector option[value=2]').attr('selected', 'selected');
                    } else {
                        $('#selector option[value=1]').attr('selected', 'selected');
                    };


                });
            }).fail(function (xhr) {
                console.log(xhr.status + xhr.responseText);
            });//end ajax

        };

    </script>
    <script>
        //預覽照片
        var loadFile = function (event) {
            var output = document.getElementById('output');
            output.src = URL.createObjectURL(event.target.files[0]);
            output.onload = function () {
                URL.revokeObjectURL(output.src) // free memory
            }
        };
        //變更地點資料庫
        //新增資料至資料庫
        function UpLoadLoctionFormButton() {
            console.log("現在的id是" + _LocationID);
            $("#UploadLocationForm").ajaxSubmit({
                type: "POST",
                url: "/Home/createAlocation",
                //data: { EditLocationId: _LocationID },
                success: function (response) {
                    console.log(response);

                    if (response == "photoIsnotUploaded") {//如果沒有照片
                        Swal.fire(
                            '什麼?!沒有照片?',
                            '來張照片吧',
                            'warning',
                        )
                        return;
                    }
                    Swal.fire({
                        //position: 'top-end',
                        icon: 'success',
                        title: 'Your work has been saved',
                        showConfirmButton: false,
                        timer: 1000
                    })

                    CreateEditmodal.style.display = "none";
                    _marker.remove();
                    reload();
                },
                fail: function (failresponse) {

                    console.log(failresponse);
                }

            });
        };

        ///更新資料至資料庫
        function EditLoctionFormButton() {

            console.log("現在的id是" + _LocationID);
            $("#UploadLocationForm").ajaxSubmit({
                type: "POST",
                url: "/Home/EditLocationInfo",
                //data: { EditLocationId: _LocationID },
                success: function (response) {
                    //console.log(response);


                    var obj = document.getElementsByName("checkbox");

                    if (response == "photoIsnotUploaded") {//如果沒有照片
                        Swal.fire(
                            '什麼?!沒有照片?',
                            '來張照片吧',
                            'warning',
                        )
                        return;
                    }

                    Swal.fire({
                        //position: 'top-end',
                        icon: 'success',
                        title: 'Your work has been saved',
                        showConfirmButton: false,
                        timer: 1000
                    })


                    CreateEditmodal.style.display = "none";
                    reload();

                },
                fail: function (failresponse) {

                    console.log(failresponse);
                }

            });
        };


    </script>

    <script>

        //文件載入:處理個人資料方塊,地點路線分布
        $(document).ready(function (e) {
            //reloadRoute();
            reload();
            $("#toggle2").click(function () {
                $("#showHide").toggle();
            });
            $("#addNewLocationButton").hide();

        });
        //左側滑動清單設定
        $('#LeftSideMenu').BootSideMenu({
            side: "left",
            pushBody: true,
            autoClose: false,
            closeOnClick: false
        });


        //飛躍至該地k
        function fly(Point) {
            map.flyTo({
                center: Point, // [X,Y] Array
                essential: true,
                zoom: 13
            });
        }

        //ajax重整重新載入所有地點路線

        //重整
        function reload() {
            console.log("reload");
            LocArray = []

            $.ajax({
                url: "/Home/getAllLocations",
                type: "POST",
                dataType: "json",
                //data: { }
            }).done(function (response) {
                //console.log(response);
                for (var i = 0; i < response.length; i++) {
                    Coords_Location = [response[i].fX_Coordinate, response[i].fY_Coordinate];
                    Id_Location = response[i].fId_Location;

                    locJson =
                    {
                        'type': 'Feature',
                        'properties': {
                            'description': Id_Location
                        },
                        'geometry': {
                            'type': 'Point',
                            'coordinates': Coords_Location
                        }
                    };
                    LocArray.push(locJson);
                }//end for
                if (map.getLayer("places")) {
                    map.removeLayer("places");
                }

                if (map.getLayer("routes")) {
                    map.removeLayer("routes");
                }
                if (map.getSource("places")) {
                    map.removeSource("places");
                }

                if (map.getSource("routes")) {
                    map.removeSource("routes");
                }


                reloadRoute();

            }).fail(function (xhr) {
                console.log(xhr.status + xhr.responseText);
            });//end ajax
        }

        //"取得路線"的第一個坐標，fly()要用到k
        function GetRoutePathArray(RouteInnerHTMLPath) {
            var RoutePath = new Array();
            var tempPoint = new Array();
            var strRoutePath = (RouteInnerHTMLPath + "").split(',');
            for (var i = 0; i < strRoutePath.length; i += 2) {
                tempPoint[i / 2] = new Array();
                tempPoint[i / 2][1] = strRoutePath[i + 1];
                tempPoint[i / 2][0] = strRoutePath[i];
                RoutePath.push(tempPoint[i / 2]);
            }
            return RoutePath;
        }

        //重新放入路線
        //路線所有資訊組成json，放到陣列
        var RouArray;
        function reloadRoute() {
            //console.log("reloadRoute");
            RouArray = []
            $.ajax({
                url: "/Home/getAllRoutes",
                type: "POST",
                dataType: "json",
                //data: { }
            }).done(function (response) {
                console.log(response);
                for (var i = 0; i < response.length; i++) {

                    Id_Route = response[i].fId_Route;
                    //console.log(Id_Route);
                    Path_Route = GetRoutePathArray(response[i].fPath_Route);

                    rouJson =
                    {
                        'type': 'Feature',
                        'properties': {
                            'description': Id_Route
                        },
                        'geometry': {
                            'type': 'LineString',
                            'coordinates': Path_Route
                        }
                    };
                    RouArray.push(rouJson);
                    //console.log(RouArray);

                }//end for

                reloadlocation();
            }).fail(function (xhr) {
                console.log(xhr.status + xhr.responseText);
            });//end ajax

        };


        //重新放入地點/路線
        function reloadlocation() {

            //console.log("reloadAll");
            map.loadImage(
                'https://docs.mapbox.com/mapbox-gl-js/assets/custom_marker.png',
                // Add an image to use as a custom marker
                function (error, image) {



                    if (error) throw error;
                    //console.log(map.hasImage('custom-marker'));

                    if (!map.hasImage('custom-marker')) {
                        map.addImage('custom-marker', image);
                    };


                    map.addSource('places', {
                        'type': 'geojson',
                        'data': {
                            'type': 'FeatureCollection',
                            'features': LocArray
                        }
                    });

                    // Add a layer showing the places.
                    map.addLayer({
                        'id': 'places',
                        'type': 'symbol',
                        'source': 'places',
                        'layout': {
                            'icon-image': 'custom-marker',
                            'icon-allow-overlap': true
                        }
                    });

                });

            //路線加入地圖k====================
            map.addSource('routes', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': RouArray
                }
            });//End：map.addSource

            map.addLayer({
                'id': 'routes',
                'type': 'line',
                'source': 'routes',
                layout: {
                    "line-join": "round",
                    "line-cap": "round"
                },
                paint: {
                    "line-color": "#dc143c",
                    "line-width": 6
                }
            });//End：map.addLayer



        };



    </script>


    <script>
    @* 登入 *@
    $('#loginBtn').on('click', login);
    function login() {
            var login_data = {
                email: $("#account").val(),
                pwd: $("#password").val()
            };

        $.ajax({
            url: '@Url.Action("login", "Home")',
            type: "POST",
            dataType: "json",
            data: login_data
        }).done(function (response) {
            //alert("account: " + login_data.email + " password: " + login_data.pwd);
            //console.log(response.fEmail_Member);
            alert(response.loginMessage);
            window.location.reload()
        }).fail(function (xhr, ajaxOptions, thrownError) {
            $("body").append(xhr.status);
            $("body").append(xhr.responseText);
            alert(thrownError);
        });
    };

    //登出
    $('#logoutBtn').on('click', logout);
        function logout() {
            var login_data = {
                email: $("#login_email").val(),
            };
        $.ajax({
            url: '@Url.Action("logout", "Home")',
            type: "POST",
            dataType: "text",
            data: login_data
        }).done(function (response) {
            alert(response);
            window.location.reload()
        }).fail(function (xhr, ajaxOptions, thrownError) {
            $("body").append(xhr.status);
            $("body").append(xhr.responseText);
            alert(thrownError);
        })
        };

        //通知按鈕
        function showNotes() {
            var role_id = { role_id: $("#active_role").val(), read: true };
            $.ajax({
                url:'@Url.Action("get", "Note")',
                type: "get",
                dataType: "json",
                data: role_id
            }).done(function (response) {
                $("#info_panel").html('<ul id="note_list"></ul>');
                for (let i = 0; i < response.length; i++) {
                    let note_item = "<li id=note_li" + i+">";
                    note_item += "[" + response[i].fMessage_Note + "]";
                    note_item += "[" + response[i].fTimeReadable_Note + "]";
                    note_item += "</li>";
                    $("#note_list").append(note_item);
                    $("#noteNum").hide();
                    console.log(response[i].fMessage_Note);
                };
            }).fail(function (xhr, ajaxOptions, thrownError) {
                $("body").append(xhr.status);
                $("body").append(xhr.responseText);
                alert(thrownError);
            })
        };

        //切換身分按鈕
        function showRoles() {
            var member_id = { member_id: $("#login_id").val() };
            $.ajax({
                url:'@Url.Action("get", "Role")',
                type: "GET",
                dataType: "json",
                data: member_id
            }).done(function (response) {
                $("#info_panel").html('<ul id="role_list"></ul>');
                for (let i = 0; i < response.length; i++) {
                    let role_item = "";
                    role_item += "<li>";
                    role_item += "<button value='" + response[i].fId_Role + "'";
                    role_item += "name = '" + response[i].fNickName_Role + "'";
                    role_item += "onclick='changeRole(this)'>";
                    role_item += response[i].fNickName_Role;
                    if (response[i].fId_Slave_Type_Role == "a")
                    {
                        role_item += "(管理員)";
                    };
                    if (response[i].fId_Slave_Type_Role == "b") {
                        role_item += "(營利會員)";
                    };
                    role_item += "</button></li>";
                    console.log(response[i].fNickName_Role);
                    $("#role_list").append(role_item)

                };
            }).fail(function (xhr, ajaxOptions, thrownError) {
                $("body").append(xhr.status);
                $("body").append(xhr.responseText);
                alert(thrownError);
            })
        };
        //切換身分連結
        function changeRole(myobj) {

            $("#follower_list").html("");

            var role_id = { role_id: myobj.value };
            alert("即將切換為: " + myobj.name);

            $.ajax({
                url: '@Url.Action("changeRole", "Home")',
                type: "POST",
                dataType: "json",
                data: role_id
            }).done(function (response) {
                alert("已切換身分為: " + response.fNickName_Role);
                $('#active_role').attr('value', response.fId_Role);
                document.getElementById("active_role_name").innerHTML = "目前身分:" + response.fNickName_Role;
                if (response.fId_Slave_Type_Role == "a") {
                    alert("管理員 " + response.fNickName_Role + ", 您好!");
                }
            }).fail(function (xhr, ajaxOptions, thrownError) {
                console.log(role_id);
                $("body").append(xhr.status);
                $("body").append(xhr.responseText);
                alert(thrownError);
            })
        };
        //讀取點數細節
        function showPoint() {
            $.ajax({
                url: '@Url.Action("get", "Point")',
                type: "GET",
                dataType: "json",
                data: { role_id: $("#active_role").val() },
            }).done(function (response){
                $("#info_panel").html('<ul id="points_list"></ul>');
                for (let i = 0; i < response.length; i++) {
                    console.log(response[i]);
                    let point_item = "<li>";
                    point_item += "[" + response[i].fPoint_Point + "] ";
                    point_item += "[" + response[i].fType_Point + "] ";
                    point_item += "[" + response[i].fTimeReadable_Point + "] ";
                    point_item += "</li>";
                    $("#points_list").append(point_item);
                };
            }).fail(function (xhr, ajaxOptions, thrownError) {
                console.log(role_id);
                $("body").append(xhr.status);
                $("body").append(xhr.responseText);
                alert(thrownError);
            })
        };
    </script>
</body>
</html>
